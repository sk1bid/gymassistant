name: Deploy GymAssistant Bot to K3s

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      # üß© 1. –ó–∞–±–∏—Ä–∞–µ–º –∫–æ–¥
      - name: Checkout code
        uses: actions/checkout@v4

      # ü™£ 2. –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GHCR
      - name: Log in to GHCR
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # üõ†Ô∏è 3. –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º Docker-–æ–±—Ä–∞–∑ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Ç–µ–≥–æ–º (commit SHA)
      - name: Build and push Docker image
        env:
          REPO: ghcr.io/${{ github.repository }}
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          if [ "${{ github.ref_name }}" = "main" ]; then
            TAG="prod-$SHORT_SHA"
          else
            TAG="dev-$SHORT_SHA"
          fi

          echo "üî® Building image: $REPO:$TAG"
          docker build -t $REPO:$TAG .

          echo "üì¶ Pushing image to GHCR..."
          docker push $REPO:$TAG

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–≥ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
          echo "TAG=$TAG" >> $GITHUB_ENV

      # üöÄ 4. –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ SSH
      - name: Deploy to K3s over SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 2222
          script: |
            REPO="ghcr.io/${{ github.repository }}"
            TAG=${{ env.TAG }}
            NAMESPACE=$( [ "${{ github.ref_name }}" = "main" ] && echo "gym-prod" || echo "gym-dev" )

            echo "üåÄ Deploying image $REPO:$TAG to namespace $NAMESPACE"

            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑ –≤ –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç–µ
            kubectl set image deploy/gym-bot aiogram-bot=$REPO:$TAG -n $NAMESPACE

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
            echo "‚úÖ Restarting bot..."
            kubectl rollout restart deploy/gym-bot -n $NAMESPACE

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üîç Waiting for rollout to complete..."
            kubectl rollout status deploy/gym-bot -n $NAMESPACE

            echo "üéâ Deployment complete!"
